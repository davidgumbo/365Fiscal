# 365 Fiscal - Digital Ocean Deployment Guide

## Quick Deployment

### Prerequisites
- Ubuntu 22.04 or 24.04 droplet
- Root access
- At least 1GB RAM recommended

### One-Command Deployment

SSH into your Digital Ocean droplet and run:

```bash
# Navigate to /opt
cd /opt

# Clone the repository (if not already cloned)
git clone https://github.com/davidgumbo/365Fiscal.git 365_fiscal

# Make the deploy script executable and run it
chmod +x /opt/365_fiscal/deploy/deploy_365fiscal.sh
/opt/365_fiscal/deploy/deploy_365fiscal.sh
```

Or if you already have the repo at `/opt/365_fiscal`:

```bash
cd /opt/365_fiscal
chmod +x deploy/deploy_365fiscal.sh
./deploy/deploy_365fiscal.sh
```

## What Gets Deployed

| Component | Port | Technology |
|-----------|------|------------|
| Frontend | 8070 | Nginx serving React build |
| Backend API | 8089 | Gunicorn + Uvicorn (FastAPI) |
| Database | 5432 | PostgreSQL |

## Service Management

### Using systemctl directly:
```bash
# Check backend status
systemctl status 365fiscal-backend

# Restart backend
systemctl restart 365fiscal-backend

# View backend logs
journalctl -u 365fiscal-backend -f

# Restart nginx (frontend)
systemctl restart nginx
```

### Using the management script:
```bash
chmod +x /opt/365_fiscal/deploy/manage_365fiscal.sh

# Start services
./manage_365fiscal.sh start

# Stop services
./manage_365fiscal.sh stop

# Restart services
./manage_365fiscal.sh restart

# Check status
./manage_365fiscal.sh status

# View logs
./manage_365fiscal.sh logs
```

## Updating the Application

After pushing changes to GitHub:

```bash
chmod +x /opt/365_fiscal/deploy/update_365fiscal.sh
/opt/365_fiscal/deploy/update_365fiscal.sh
```

## Configuration

### Backend Environment Variables
Located at: `/opt/365_fiscal/backend/.env`

```env
APP_NAME=365 FISCAL
ENV=production
SECRET_KEY=<auto-generated>
DATABASE_URL=postgresql+psycopg://fiscal365_user:<password>@localhost:5432/fiscal365
CORS_ORIGINS=http://<your-ip>:8070
```

### Changing Database Password
```bash
# 1. Update PostgreSQL
sudo -u postgres psql -c "ALTER USER fiscal365_user PASSWORD 'new_password';"

# 2. Update .env file
nano /opt/365_fiscal/backend/.env

# 3. Restart backend
systemctl restart 365fiscal-backend
```

## Troubleshooting

### Backend not starting
```bash
# Check logs
journalctl -u 365fiscal-backend -n 50

# Test manually
cd /opt/365_fiscal/backend
source venv/bin/activate
python -c "from app.main import app; print('OK')"
```

### Database connection issues
```bash
# Check PostgreSQL status
systemctl status postgresql

# Test connection
sudo -u postgres psql -d fiscal365 -c "SELECT 1;"
```

### Frontend not loading
```bash
# Check nginx status
systemctl status nginx

# Check nginx logs
tail -f /var/log/nginx/error.log

# Verify build exists
ls -la /opt/365_fiscal/frontend/dist/
```

### CORS errors
Update `/opt/365_fiscal/backend/.env`:
```env
CORS_ORIGINS=http://your-domain.com:8070,http://your-ip:8070
```
Then restart: `systemctl restart 365fiscal-backend`

## Firewall

The deploy script configures UFW automatically:
```bash
# Check firewall status
ufw status

# Manually allow ports if needed
ufw allow 8070/tcp
ufw allow 8089/tcp
```

## SSL/HTTPS Setup (Optional)

For production with a domain:

```bash
# Install certbot
apt install certbot python3-certbot-nginx

# Get certificate
certbot --nginx -d yourdomain.com

# Update .env CORS_ORIGINS to use https
```

## Deployment Information

After deployment, credentials are saved to:
`/opt/365_fiscal/DEPLOYMENT_INFO.txt`

## Default Logins

| Account | Email | Password |
|---------|-------|----------|
| Admin | admin@365fiscal.local | Admin@365Fiscal! |
| Portal | portal@365fiscal.local | Portal@365! |

**Important:** Change these passwords after first login!
